
# ISUPipe アプリケーションマニュアル


## ISUPipeについて

新進気鋭のライブ配信サービスISUPipeのリリースが予定されています。
ライブ配信に対する「ライブコメント」や、配信者に対する「投げ銭」をはじめとして、リアクション機能や配信者の独自ドメインなど他にはない機能を取り揃えているサービスです。
そんなISUPipeですが、社員の知り合いを呼びあつめて確認してもらったところ、多くの不満が寄せられました。
ISUPipeのロードマップでは2024/04/01 ~ 2025/03/31の期間どのようなことを行なっていくか定めているのでそれに合わせて検証してもらっていますが、来年リリースが迫るなか、多くのライブ配信者から先行予約したい、配信テストや体験などをひと足先に試したいなどの多くの声もいただいており、これを裏切りたくありません。
配信テストの要望は、最も早いもので８時間後に迫っている状況であり、予断を許さない状況です。あなたにはこれからの８時間の間、ISUPipeが予約を開始できるように改善していただき、多くの未来の利用者にリアルタイムな配信を提供していただきたいと考えています。

## 用語

### Webアプリケーション

* ユーザー
  * 配信者(streamer): ライブ配信を行う配信者です。
  * 視聴者(viewer): ライブ配信を視聴する視聴者です。
* ライブコメント(Livecomment): ライブ配信に対するリアルタイムなコメントです。
* 投げ銭(Tip): ライブ配信、ライブ配信者に対する送金・寄付です。
* リアクション(Reaction): ライブ配信に対するリアクションです。 `:innocent:` や `:+1:` などフロントエンドで絵文字として解釈されて表示されます。
* サブドメイン: ライブ配信者が個々に所有するサブドメインです。このドメインに応じてフロントエンドの見た目が変わります。競技環境で動作するDNS権威サーバによって提供される機能です。
* ライブストリーム(Livestream): ライブ配信です。また、予約期間を保持するため、予約としての機能も兼ねています。
* 人気配信者: 一定のライブコメント数、投げ銭売り上げ合計を達成し、スパム報告数を一定以下に抑えて善良な配信を行なっている配信者です。
* 人気配信: 人気配信者の配信です。その配信が人気かどうかによりません。人気になる期待がある配信、人気である配信のニュアンスを含みます。
* 炎上配信: 他の配信と比較して相対的にスパム数が多い配信です。スパムが集中しやすく、投げ銭による稼ぎが得られにくい配信です。
* ユーザ配信統計情報: ユーザが投稿したライブコメント、投げ銭、リアクションに関する統計情報です。
* ライブ配信統計情報: ライブ配信に投稿されたライブコメント、投げ銭、リアクションに関する統計情報です。
* 課金(Payment): webappが稼いだ総投げ銭金額です。加えて、整合性が崩れていないか自動チェックするため、過去の予約やライブコメントに関する情報を持ちます。
* 広告費用係数: この値に基づいて、ISUPipe公式からさまざまな手段を用いた広報、Web広告を打ち出します。これによりトラフィックが増大します。

## サーバ構成

* webapp
  * ISUPipeをサービスする中核となるアプリケーション
  * あなたにはこれを担当してもらいます
  * なお、課金サーバも兼ねており、合計の投げ銭売上を計上する必要があります
* bench
  * webappに負荷を書けるアプリケーションです
  * ここは運営側で管理しています。
* HLS配信サーバ
  * フロントエンドで鑑賞可能なライブ配信コンテンツを提供するアプリケーションです
  * ここは運営で管理しています。


## ISUPipeのロードマップ

2024/04/01 ~ 2025/03/31 の期間について、ISUPipe公式からロードマップが提供されます。

* 第１期 (2024/04/01 ~ 2024/06/30)
   * 登録済みの配信者について、予約が事前に用意されています
   * この予約について、ライブコメントと投げ銭のトラフィックが流れます
   * 新規のユーザ登録、予約はここでは行われません
* 第２期 (2024/07/01 ~ 2024/09/31)
   * 新人VTuberの登録が始まります。
   * ユーザ登録に加え、それら配信者からの予約リクエストも来るようになります。
   * もちろん、ライブコメントや投げ銭のトラフィックも流れます（ライブコメント、投げ銭はどの期も流れるようになっています）
* 第３期 (2024/10/01 ~ 2024/12/31)
   * 一定数ユーザを収容したことで、複雑なリクエストが飛んでくるようになります。
   * 配信に対する投稿などだけでなく、スパムやDNSに対する攻撃なども行われるようになります。
* 第４期 (2024/01/01 ~ 2024/03/31)
   * 一通りの障壁を突破し、以降予約や配信に対するライブコメントや投げ銭が中心のトラフィックになります。
   * 人気VTuberも増えるので、売上が増えやすくなります。

まず第1期から始まり、達成条件を満たすと第2期に突入し・・・というベンチマーカーの動きをします。
第1期〜第4期はそれぞれPhase1~Phase4と対応します。

達成条件はログに出力されますが、現状以下のとおりです

```
Phase1達成条件:  70000 ISUCOIN
Phase2達成条件:  90000 ISUCOIN
Phase3達成条件: 110000 ISUCOIN
```

## Webアプリケーションの振る舞い

基本的には、以下のような機能を提供します

* ライブ配信
  * ライブコメント (投げ銭を兼ねる)
  * リアクション
  * スパム報告

* ライブ配信管理
  * 予約
  * NGワード登録(moderate)
    * 配信者は、視聴者からのスパム報告を参考にしてNGワードを登録する
    * 登録以後、新規ライブコメント投稿においてNGワードのマッチ処理が行われ、問題がある場合はエラーを返すようになる
   
* ユーザ管理
  * 登録
  * ログイン

* 統計情報
  * ライブ配信に関する統計情報
  * ユーザに関する統計情報

## ベンチマーカーの振る舞い

基本的には、ロードマップに従ってトラフィックを生成します。

ユーザは、ライブ配信を視聴する前に、関心のある配信情報や配信者情報を見に行く傾向があります。

## 事前回答会で実装できていないもの

* DNS
 * 環境が用意でき次第、準備します
* リアクション投稿
* ロック競合を起こすシナリオ（まったくないわけではないですが、不足しています）
* 達成条件のチューニング (不足している）
* Phase3以降の実装の詰め
* 人気、不人気、炎上などもともと考えていた要素
* コラボ配信


