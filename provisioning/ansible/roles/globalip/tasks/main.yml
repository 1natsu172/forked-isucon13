- name: ISUCON_SUBDOMAIN_ADDRESS file
  become: true
  copy:
    content: |
      # Ansible で生成されました。編集は可能です
      ISUCON_SUBDOMAIN_ADDRESS={{ ansible_default_ipv4.address }}
    dest: /home/isucon/env-isucon-subdomain-address.sh
    owner: isucon
    group: isucon
    mode: 0755

- name: generator ISUCON_SUBDOMAIN_ADDRESS
  become: true
  copy:
    content: |
      #!/usr/bin/env bash
      set -eux
      if (test -f /opt/gen-env-isucon-subdomain-address.sh.lock); then
        exit
      fi
      instance_ip=$(curl -m 10 -s curl http://169.254.169.254/latest/meta-data/public-ipv4)
      if [ -n $instance_ip ]; then
        echo "# generated by env-isucon-subdomain-address. 編集可能です" > /home/isucon/env-isucon-subdomain-address.sh
        echo "ISUCON_SUBDOMAIN_ADDRESS=${instance_ip}" >> /home/isucon/env-isucon-subdomain-address.sh
      fi
      chmod 0755 /home/isucon/env-isucon-subdomain-address.sh
      chown isucon:isucon /home/isucon/env-isucon-subdomain-address.sh
      touch /opt/gen-env-isucon-subdomain-address.sh.lock
    dest: /opt/gen-env-isucon-subdomain-address.sh
    owner: root
    group: root
    mode: 0755

- name: generator ISUCON_SUBDOMAIN_ADDRESS service
  become: true
  copy:
    content: |
      [Unit]
      Description=run gen-env-isucon-subdomain-address once
      Wants=time-sync.target
      Before=time-sync.target
      After=network.target

      [Service]
      Restart=no
      Type=simple
      RemainAfterExit=yes
      ExecStart=/opt/gen-env-isucon-subdomain-address.sh

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/gen-env-isucon-subdomain-address.service
    mode: 0644

- name: Enable test service
  become: true
  systemd_service:
    name: gen-env-isucon-subdomain-address
    enabled: true
    daemon_reload: true